<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>딥보이스 체험 - 필터온</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --bg-primary: #0f0f0f;
        --bg-secondary: #1a1a1a;
        --bg-card: #252525;
        --text-primary: #ffffff;
        --text-secondary: #a0a0a0;
        --text-muted: #666666;
        --accent: #357051;
        --accent-light: #4a9a6e;
        --danger: #ef4444;
        --danger-dark: #dc2626;
      }

      body {
        font-family:
          "Noto Sans KR",
          -apple-system,
          BlinkMacSystemFont,
          sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .overlay {
        position: fixed;
        inset: 0;
        background: var(--bg-primary);
        display: flex;
        flex-direction: column;
        z-index: 9999;
      }

      .header {
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #333;
      }

      .logo {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--accent);
      }

      .step-indicator {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        font-size: 0.875rem;
        color: var(--text-secondary);
      }

      .step-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--text-muted);
        transition: all 0.3s ease;
      }

      .step-dot.active {
        background: var(--accent);
        width: 24px;
        border-radius: 4px;
      }

      .step-dot.completed {
        background: var(--accent);
      }

      .close-btn {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 4px;
        transition: all 0.2s;
      }

      .close-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
      }

      .content {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        overflow-y: auto;
      }

      .screen {
        display: none;
        flex-direction: column;
        align-items: center;
        text-align: center;
        max-width: 600px;
        width: 100%;
        animation: fadeIn 0.5s ease;
      }

      .screen.active {
        display: flex;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.05);
          opacity: 0.8;
        }
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
      }

      .subtitle {
        font-size: 1rem;
        color: var(--text-secondary);
        margin-bottom: 2rem;
      }

      .script-card {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        width: 100%;
        border: 1px solid #333;
      }

      .script-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 0.75rem;
      }

      .script-text {
        font-size: 1.125rem;
        line-height: 1.8;
        color: var(--text-primary);
      }

      .record-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
      }

      .record-btn {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: none;
        background: var(--danger);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        position: relative;
      }

      .record-btn:hover {
        background: var(--danger-dark);
        transform: scale(1.05);
      }

      .record-btn.recording {
        animation: pulse 1.5s infinite;
      }

      .record-btn.recording::before {
        content: "";
        position: absolute;
        inset: -8px;
        border-radius: 50%;
        border: 2px solid var(--danger);
        animation: pulse 1.5s infinite;
      }

      .record-icon {
        width: 24px;
        height: 24px;
        background: white;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .record-btn.recording .record-icon {
        border-radius: 4px;
        width: 20px;
        height: 20px;
      }

      .timer {
        font-size: 2rem;
        font-weight: 600;
        font-variant-numeric: tabular-nums;
        color: var(--text-primary);
      }

      .timer-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
      }

      .btn {
        padding: 1rem 2rem;
        border-radius: 12px;
        border: none;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-primary {
        background: var(--accent);
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background: var(--accent-light);
        transform: translateY(-2px);
      }

      .btn-primary:disabled {
        background: var(--text-muted);
        cursor: not-allowed;
      }

      .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2rem;
      }

      .spinner {
        width: 60px;
        height: 60px;
        border: 3px solid var(--bg-card);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .loading-text {
        font-size: 1.25rem;
        color: var(--text-secondary);
      }

      .loading-subtext {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-top: 0.5rem;
      }

      .result-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
        width: 100%;
      }

      .play-btn {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent), var(--accent-light));
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 8px 32px rgba(53, 112, 81, 0.3);
      }

      .play-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 12px 40px rgba(53, 112, 81, 0.4);
      }

      .play-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .play-icon {
        width: 0;
        height: 0;
        border-left: 24px solid white;
        border-top: 14px solid transparent;
        border-bottom: 14px solid transparent;
        margin-left: 6px;
      }

      .warning-container {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 2rem;
        margin-top: 1.5rem;
        border-left: 4px solid var(--accent);
        text-align: left;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.8s ease;
        pointer-events: none;
      }

      .warning-container.visible {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }

      .warning-text {
        font-size: 1rem;
        line-height: 1.8;
        color: var(--text-secondary);
      }

      .warning-text strong {
        color: var(--text-primary);
      }

      .warning-text p {
        margin-bottom: 1rem;
      }

      .warning-text p:last-child {
        margin-bottom: 0;
      }

      .close-btn-main {
        margin-top: 2rem;
      }

      .error-container {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid var(--danger);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        width: 100%;
      }

      .error-title {
        color: var(--danger);
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .error-text {
        color: var(--text-secondary);
        font-size: 0.875rem;
      }

      .permission-guide {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        width: 100%;
        text-align: left;
      }

      .permission-title {
        font-weight: 600;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .permission-steps {
        font-size: 0.875rem;
        color: var(--text-secondary);
        line-height: 1.6;
      }

      .mic-icon {
        width: 20px;
        height: 20px;
      }

      @media (max-width: 640px) {
        .content {
          padding: 1rem;
        }

        .title {
          font-size: 1.25rem;
        }

        .subtitle {
          font-size: 0.875rem;
        }

        .script-text {
          font-size: 1rem;
        }

        .record-btn {
          width: 70px;
          height: 70px;
        }

        .timer {
          font-size: 1.5rem;
        }

        .warning-container {
          padding: 1.5rem;
        }

        .warning-text {
          font-size: 0.875rem;
        }
      }
    </style>
  </head>
  <body>
    <div
      class="overlay"
      id="overlay"
      role="dialog"
      aria-modal="true"
      aria-labelledby="overlay-title"
    >
      <header class="header">
        <div class="logo">필터온</div>
        <div
          class="step-indicator"
          role="progressbar"
          aria-valuenow="1"
          aria-valuemin="1"
          aria-valuemax="3"
        >
          <span id="step-text">1/3</span>
          <div class="step-dot active" id="dot1"></div>
          <div class="step-dot" id="dot2"></div>
          <div class="step-dot" id="dot3"></div>
        </div>
        <button class="close-btn" id="header-close-btn" aria-label="체험 닫기">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M18 6L6 18M6 6l12 12" />
          </svg>
        </button>
      </header>

      <main class="content">
        <div class="screen active" id="screen-record">
          <h1 id="overlay-title" class="title">음성을 녹음해주세요</h1>

          <div class="permission-guide" id="permission-guide">
            <div class="permission-title">
              <svg
                class="mic-icon"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                aria-hidden="true"
              >
                <path
                  d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"
                ></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
              </svg>
              마이크 권한이 필요합니다
            </div>
            <p class="permission-steps">
              녹음 버튼을 누르면 브라우저에서 마이크 권한을 요청합니다.<br />
              "허용"을 선택해주세요.
            </p>
          </div>

          <div class="script-card">
            <div class="script-label">읽어주세요</div>
            <p class="script-text" id="script-display"></p>
          </div>

          <div class="record-container">
            <button class="record-btn" id="record-btn" aria-label="녹음 시작">
              <div class="record-icon"></div>
            </button>
            <div>
              <div class="timer" id="timer" aria-live="polite">00:00</div>
              <div class="timer-label" id="timer-label">녹음 대기 중</div>
            </div>
          </div>

          <div
            class="error-container"
            id="error-container"
            style="display: none"
            role="alert"
          >
            <div class="error-title" id="error-title">오류가 발생했습니다</div>
            <p class="error-text" id="error-text"></p>
          </div>

          <button
            class="btn btn-primary"
            id="convert-btn"
            disabled
            style="margin-top: 2rem"
          >
            다음으로
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              aria-hidden="true"
            >
              <path d="M5 12h14M12 5l7 7-7 7" />
            </svg>
          </button>
        </div>

        <div
          class="screen"
          id="screen-loading"
          role="status"
          aria-live="polite"
        >
          <div class="loading-container">
            <div class="spinner" aria-hidden="true"></div>
            <div>
              <div class="loading-text">음성을 변환하고 있습니다...</div>
              <div class="loading-subtext">잠시만 기다려주세요</div>
            </div>
          </div>
        </div>

        <div class="screen" id="screen-result">
          <h1 class="title">작업이 완료되었습니다</h1>
          <p class="subtitle">버튼을 눌러 음성을 들어보세요</p>

          <div class="result-container">
            <button
              class="play-btn"
              id="play-btn"
              aria-label="변환된 음성 재생"
            >
              <div class="play-icon" aria-hidden="true"></div>
            </button>
            <p class="timer-label" id="play-label" aria-live="polite">
              들어보기
            </p>

            <div
              class="warning-container"
              id="warning-container"
              aria-hidden="true"
            >
              <div class="warning-text">
                <p>
                  <strong>어떠신가요?</strong> 이 음성은 AI로 생성된
                  '딥보이스'(Deep Voice)입니다.
                </p>
                <p>
                  짧게 말한 그 순간, 당신과 비슷한 목소리를 만들어 낼 수
                  있습니다.
                </p>
                <p>
                  지금 체험해보신 기술이, 실제로는 피싱이나 각종 사기에 악용되는
                  사례가 늘고 있습니다.
                </p>
                <p>
                  <strong>필터온</strong>은 딥보이스 체험뿐만 아니라,
                  피싱·스미싱 등 디지털 사기 예방 교육을 함께 제공합니다.
                </p>
                <p>
                  방금 느낀 그 놀라움과 위험성을 한순간의 감정으로 끝내지
                  마세요.<br />
                  조금만 더 관심을 가지고 대비한다면, 앞으로 다가올 더 큰 위험을
                  막을 수 있습니다.
                </p>
              </div>
            </div>

            <button class="btn btn-primary close-btn-main" id="close-btn">
              체험 종료
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                aria-hidden="true"
              >
                <path d="M5 12h14M12 5l7 7-7 7" />
              </svg>
            </button>
          </div>
        </div>
      </main>
    </div>

    <script>
      // ========================================
      // 설정 변수 (개발자가 수정)
      // ========================================
      const SCRIPT_TEXT =
        "여보세요? 엄마 어디야? 나 감기 걸린 거 같은데... 오늘 학원 안 가도 돼?";
      const DEEPVOICE_TEXT =
        "무서워... 나 어디있는지 모르겠어. 어떤 아저씨들 차에 탔어...";

      const SESSION_KEY = "filteron_deepvoice_event_visited";

      // ========================================
      // 상태 관리
      // ========================================
      let mediaRecorder = null;
      let mediaStream = null;
      let audioChunks = [];
      let recordedBlob = null;
      let recordedBlobUrl = null;
      let convertedAudioUrl = null;
      let timerInterval = null;
      let recordingStartTime = null;
      let isRecording = false;
      let hasPlayed = false;

      // ========================================
      // DOM 요소
      // ========================================
      const overlay = document.getElementById("overlay");
      const screenRecord = document.getElementById("screen-record");
      const screenLoading = document.getElementById("screen-loading");
      const screenResult = document.getElementById("screen-result");
      const scriptDisplay = document.getElementById("script-display");
      const recordBtn = document.getElementById("record-btn");
      const convertBtn = document.getElementById("convert-btn");
      const playBtn = document.getElementById("play-btn");
      const closeBtn = document.getElementById("close-btn");
      const headerCloseBtn = document.getElementById("header-close-btn");
      const timer = document.getElementById("timer");
      const timerLabel = document.getElementById("timer-label");
      const playLabel = document.getElementById("play-label");
      const warningContainer = document.getElementById("warning-container");
      const errorContainer = document.getElementById("error-container");
      const errorTitle = document.getElementById("error-title");
      const errorText = document.getElementById("error-text");
      const permissionGuide = document.getElementById("permission-guide");
      const stepText = document.getElementById("step-text");
      const stepIndicator = document.querySelector(".step-indicator");
      const dot1 = document.getElementById("dot1");
      const dot2 = document.getElementById("dot2");
      const dot3 = document.getElementById("dot3");

      // ========================================
      // 리소스 정리
      // ========================================
      function cleanupResources() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }

        if (mediaStream) {
          mediaStream.getTracks().forEach((track) => track.stop());
          mediaStream = null;
        }

        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          try {
            mediaRecorder.stop();
          } catch (e) {}
        }
        mediaRecorder = null;

        if (recordedBlobUrl) {
          URL.revokeObjectURL(recordedBlobUrl);
          recordedBlobUrl = null;
        }

        if (convertedAudioUrl) {
          URL.revokeObjectURL(convertedAudioUrl);
          convertedAudioUrl = null;
        }
      }

      // ========================================
      // 방문 표시
      // ========================================
      function markAsVisited() {
        sessionStorage.setItem(SESSION_KEY, "true");
      }

      // ========================================
      // 초기화
      // ========================================
      function init() {
        if (sessionStorage.getItem(SESSION_KEY)) {
          overlay.style.display = "none";
          return;
        }

        scriptDisplay.textContent = SCRIPT_TEXT;

        recordBtn.addEventListener("click", toggleRecording);
        convertBtn.addEventListener("click", startConversion);
        playBtn.addEventListener("click", playConvertedAudio);
        closeBtn.addEventListener("click", closeOverlay);
        headerCloseBtn.addEventListener("click", closeOverlay);

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          showError(
            "브라우저 미지원",
            "이 브라우저는 음성 녹음을 지원하지 않습니다. Chrome, Firefox, Safari 등 최신 브라우저를 사용해주세요.",
          );
          recordBtn.disabled = true;
        }
      }

      // ========================================
      // 화면 전환
      // ========================================
      function showScreen(screenName) {
        screenRecord.classList.remove("active");
        screenLoading.classList.remove("active");
        screenResult.classList.remove("active");

        dot1.classList.remove("active", "completed");
        dot2.classList.remove("active", "completed");
        dot3.classList.remove("active", "completed");

        switch (screenName) {
          case "record":
            screenRecord.classList.add("active");
            stepText.textContent = "1/3";
            stepIndicator.setAttribute("aria-valuenow", "1");
            dot1.classList.add("active");
            break;
          case "loading":
            screenLoading.classList.add("active");
            stepText.textContent = "2/3";
            stepIndicator.setAttribute("aria-valuenow", "2");
            dot1.classList.add("completed");
            dot2.classList.add("active");
            break;
          case "result":
            screenResult.classList.add("active");
            stepText.textContent = "3/3";
            stepIndicator.setAttribute("aria-valuenow", "3");
            dot1.classList.add("completed");
            dot2.classList.add("completed");
            dot3.classList.add("active");
            break;
        }
      }

      // ========================================
      // 에러 표시
      // ========================================
      function showError(title, message) {
        errorTitle.textContent = title;
        errorText.textContent = message;
        errorContainer.style.display = "block";
      }

      function hideError() {
        errorContainer.style.display = "none";
      }

      // ========================================
      // 녹음 기능
      // ========================================
      async function toggleRecording() {
        if (isRecording) {
          stopRecording();
        } else {
          await startRecording();
        }
      }

      async function startRecording() {
        try {
          hideError();

          const stream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              sampleRate: 44100,
            },
          });

          mediaStream = stream;
          permissionGuide.style.display = "none";

          const mimeType = MediaRecorder.isTypeSupported(
            "audio/webm;codecs=opus",
          )
            ? "audio/webm;codecs=opus"
            : "audio/webm";

          try {
            mediaRecorder = new MediaRecorder(stream, { mimeType });
          } catch (e) {
            stream.getTracks().forEach((track) => track.stop());
            showError(
              "녹음 초기화 실패",
              "녹음 기능을 초기화할 수 없습니다. 다른 브라우저를 사용해보세요.",
            );
            return;
          }

          audioChunks = [];

          mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
              audioChunks.push(event.data);
            }
          };

          mediaRecorder.onstop = () => {
            recordedBlob = new Blob(audioChunks, { type: mimeType });
            if (recordedBlobUrl) {
              URL.revokeObjectURL(recordedBlobUrl);
            }
            recordedBlobUrl = URL.createObjectURL(recordedBlob);
            convertBtn.disabled = false;
            timerLabel.textContent = "녹음 완료";
          };

          mediaRecorder.start(100);
          isRecording = true;
          recordingStartTime = Date.now();
          recordBtn.classList.add("recording");
          recordBtn.setAttribute("aria-label", "녹음 중지");
          recordBtn.setAttribute("aria-pressed", "true");
          timerLabel.textContent = "녹음 중...";
          convertBtn.disabled = true;

          timerInterval = setInterval(updateTimer, 100);
        } catch (error) {
          console.error("녹음 시작 실패:", error);

          if (
            error.name === "NotAllowedError" ||
            error.name === "PermissionDeniedError"
          ) {
            showError(
              "마이크 권한 거부됨",
              "마이크 사용 권한이 거부되었습니다. 브라우저 설정에서 마이크 권한을 허용해주세요.",
            );
          } else if (error.name === "NotFoundError") {
            showError(
              "마이크 없음",
              "마이크를 찾을 수 없습니다. 마이크가 연결되어 있는지 확인해주세요.",
            );
          } else {
            showError(
              "녹음 실패",
              "녹음을 시작할 수 없습니다. 다시 시도해주세요.",
            );
          }
        }
      }

      function stopRecording() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }

        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
        }

        if (mediaStream) {
          mediaStream.getTracks().forEach((track) => track.stop());
          mediaStream = null;
        }

        isRecording = false;
        recordBtn.classList.remove("recording");
        recordBtn.setAttribute("aria-label", "녹음 시작");
        recordBtn.setAttribute("aria-pressed", "false");
      }

      function updateTimer() {
        const elapsed = Date.now() - recordingStartTime;
        const seconds = Math.floor(elapsed / 1000);
        const minutes = Math.floor(seconds / 60);
        const displaySeconds = seconds % 60;
        timer.textContent = `${String(minutes).padStart(2, "0")}:${String(displaySeconds).padStart(2, "0")}`;
      }

      // ========================================
      // 음성 변환
      // ========================================
      async function startConversion() {
        if (!recordedBlob) return;

        showScreen("loading");
        hideError();

        try {
          const formData = new FormData();
          formData.append("audio", recordedBlob, "recording.webm");
          formData.append("text", DEEPVOICE_TEXT);

          const response = await fetch("/api/convert-voice", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || "변환에 실패했습니다");
          }

          const audioBlob = await response.blob();

          if (convertedAudioUrl) {
            URL.revokeObjectURL(convertedAudioUrl);
          }
          convertedAudioUrl = URL.createObjectURL(audioBlob);

          markAsVisited();
          showScreen("result");
        } catch (error) {
          console.error("변환 실패:", error);
          showScreen("record");
          showError(
            "변환 실패",
            error.message || "음성 변환에 실패했습니다. 다시 시도해주세요.",
          );
        }
      }

      // ========================================
      // 변환된 음성 재생
      // ========================================
      async function playConvertedAudio() {
        if (!convertedAudioUrl) return;

        playBtn.disabled = true;
        playLabel.textContent = "재생 중...";
        playBtn.setAttribute("aria-label", "재생 중");

        try {
          const convertedAudio = new Audio(convertedAudioUrl);
          await convertedAudio.play();

          await new Promise((resolve) => {
            convertedAudio.onended = resolve;
          });

          if (!hasPlayed) {
            hasPlayed = true;
            warningContainer.classList.add("visible");
            warningContainer.setAttribute("aria-hidden", "false");
          }

          playLabel.textContent = "다시 듣기";
          playBtn.setAttribute("aria-label", "다시 듣기");
          playBtn.disabled = false;
        } catch (error) {
          console.error("재생 실패:", error);
          playLabel.textContent = "재생 실패 - 다시 시도";
          playBtn.disabled = false;
        }
      }

      // ========================================
      // 오버레이 닫기
      // ========================================
      function closeOverlay() {
        markAsVisited();
        overlay.style.opacity = "0";
        overlay.style.transition = "opacity 0.5s ease";

        setTimeout(() => {
          cleanupResources();
          overlay.style.display = "none";
          window.location.href = "/";
        }, 500);
      }

      // ========================================
      // 시작
      // ========================================
      init();
    </script>
  </body>
</html>
